/**
 * This ruleset enforces a strict, employee-centric security model for the HighClass HR Automation system,
 * with a special role for a Super User (Admin).
 *
 * Core Philosophy:
 * The security model is based on user ownership, where each employee can only access their own data.
 * A Super User, identified by a specific email, is granted read-only access across all data for administrative purposes.
 *
 * Data Structure:
 * All data is hierarchically organized under the `/employees/{employeeId}` collection. An employee's attendance records,
 * payroll records, and deductions are stored in subcollections under their unique employee document. This structure
 * naturally scopes access control and aligns with Firestore's querying capabilities.
 *
 * Key Security Decisions:
 * - Super User Privileges: The user with email 'admin@highclass.com' has read-only access to all data.
 * - User Enumeration Disabled: Listing the root `/employees` collection is forbidden for regular users to prevent
 *   them from discovering the identities of other employees.
 * - Strict Ownership: For regular users, all operations (read, write, delete) on an employee's data tree are
 *   restricted to the authenticated user whose UID matches the `employeeId` in the document path.
 * - Path-Based Security: Authorization checks primarily rely on the `{employeeId}` wildcard in the path, which provides
 *   a highly performant and scalable way to enforce ownership without requiring extra document reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user's UID matches the provided userId.
     * This is the foundation of the ownership model for regular employees.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Checks if the requesting user is the Super User based on their email.
     */
    function isSuperUser() {
        return isSignedIn() && request.auth.token.email == 'admin@highclass.com';
    }

    /**
     * Checks if a document exists and if the requesting user is the owner.
     * Used for safe update and delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    /**
     * Common read access rule: allow if user is the owner OR a super user.
     */
    function canRead(employeeId) {
        return isOwner(employeeId) || isSuperUser();
    }

    /**
     * Validates that the employee document being created has an 'id' field
     * that matches the document's ID, ensuring path and data consistency.
     */
    function hasValidEmployeeDataOnCreate(employeeId) {
      return request.resource.data.id == employeeId;
    }

    /**
     * Enforces immutability of the employee's ID field on update.
     */
    function isEmployeeIdFieldImmutable() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates that an attendance record being created has a denormalized 'employeeId'
     * that matches the owner's ID from the path.
     */
    function hasValidAttendanceDataOnCreate(employeeId) {
      return request.resource.data.employeeId == employeeId;
    }

    /**
     * Enforces immutability of the denormalized 'employeeId' on an attendance record.
     */
    function isAttendanceEmployeeIdImmutable() {
      return request.resource.data.employeeId == resource.data.employeeId;
    }

    /**
     * Validates that a payroll record being created has a denormalized 'employeeId'
     * that matches the owner's ID from the path.
     */
    function hasValidPayrollDataOnCreate(employeeId) {
      return request.resource.data.employeeId == employeeId;
    }

    /**
     * Enforces immutability of the denormalized 'employeeId' on a payroll record.
     */
    function isPayrollEmployeeIdImmutable() {
      return request.resource.data.employeeId == resource.data.employeeId;
    }

    /**
     * Validates that a deduction being created has a denormalized 'payrollRecordId'
     * that matches the parent document's ID from the path.
     */
    function hasValidDeductionDataOnCreate(payrollRecordId) {
      return request.resource.data.payrollRecordId == payrollRecordId;
    }

    /**
     * Enforces immutability of the denormalized 'payrollRecordId' on a deduction record.
     */
    function isDeductionPayrollIdImmutable() {
      return request.resource.data.payrollRecordId == resource.data.payrollRecordId;
    }

    // --------------------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------------------

    /**
     * @description Manages employee profile documents. An employee can manage their own profile.
     * The Super User can read any employee profile and list all employees.
     * @path /employees/{employeeId}
     */
    match /employees/{employeeId} {
      allow get: if canRead(employeeId);
      allow list: if isSuperUser(); // Allow super user to list all employees
      allow create: if isOwner(employeeId) && hasValidEmployeeDataOnCreate(employeeId);
      allow update: if isExistingOwner(employeeId) && isEmployeeIdFieldImmutable();
      allow delete: if isExistingOwner(employeeId);
    }
    
    /**
     * @description Manages all attendance records in a single collection.
     * Employees can read only their own records. The Super User can read all records.
     * Employees can only create records for themselves.
     * @path /attendance/{attendanceRecordId}
     */
     match /attendance/{attendanceRecordId} {
        allow get: if isSignedIn() && (isSuperUser() || request.auth.uid == resource.data.employeeId);
        allow list: if isSuperUser();
        allow create: if isSignedIn() && request.resource.data.employeeId == request.auth.uid;
        allow update, delete: if isSignedIn() && request.auth.uid == resource.data.employeeId;
     }

    /**
     * @description Manages employee payroll records. Employees can only access their own payroll information.
     * The Super User can read all payroll records.
     * @path /payroll/{payrollId}
     */
    match /payrollHistory/{payrollId} {
        allow get, list: if isSuperUser();
        allow create: if isSuperUser();
        allow update, delete: if isSuperUser();
    }
    
     /**
      * @description Manages system-wide settings. Only the Super User can read and write settings.
      * @path /settings/main
      */
     match /settings/main {
       allow get: if isSignedIn(); // All signed-in users can read settings
       allow write: if isSuperUser();
     }
  }
}
